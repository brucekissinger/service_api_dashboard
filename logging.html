<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252"/>
    <title>Logging</title>

    <!-- link to JQuery and DataTables javascript libraries -->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
    <script src="http://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.js"></script>

    <!-- link to JQuery and DataTables CSS definitions -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="http://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.css" />

    <!-- define an internal style -->
    <style type="text/css">
        .right {
            float:right;
        }
    </style>

<script type="text/javascript">
var host_url = "ws://127.0.0.1:6464";
var service_host = "http://localhost:6467";
var service_name = "/cloudi/api/erlang/logging";
var logging_file_set_service_name = "/cloudi/api/erlang/logging_file_set";
var logging_level_set_service_name = "/cloudi/api/erlang/logging_level_set";
var logging_syslog_set_service_name = "/cloudi/api/erlang/logging_syslog_set";
var request_type = "get";
var web_socket = undefined;


function is(type, obj) {
    if (obj === undefined)
        return type === 'undefined';
    else if (obj === null)
        return type === 'null';
    else
        return type === Object.prototype.toString.call(obj).slice(8, -1);
}

String.prototype.startsWith = function (str) {
    return this.slice(0, str.length) == str;
};


function send() {
	// if the web socket is undefined then display an error
	if (web_socket == undefined) {
		$('#connectionStatus').text("Not connected");
		open();
	}

	// if the web socket is in an open status then send the request
	if (web_socket.readyState == web_socket.OPEN) {
    		web_socket.send(request_type);
    		//console.log("Request (out): " + request_type);
	}
}

function open() {
    if (! ("WebSocket" in window)) {
      	$('#connectionStatus').text("Not connected");
        alert("This browser does not support WebSockets");
        return;
    }
    
    $('#connectionStatus').text("Connecting");
    web_socket = new WebSocket(host_url + service_name);

    console.log("Connecting to " + host_url + service_name);

    // define function that is called when the web socket is opened
    web_socket.onopen = function() {
        $('#connectionStatus').text("Connected");
        console.log("Connected");
	send();
    };

    handle_message = function (data) {
        if (data.startsWith("notification:")) {
            // client state check to determine this is an incoming
            // service request, not an incoming response
            console.log("Request (in): " + data);

            var response = "ok";
            web_socket.send(response);
            console.log("Response (in): " + response);

        }
        else {
            console.log("Response (out): " + data);

		if (data != "got connect! yay!") {
		
		  // update the current configuration
        	  $('#current_configuration').text(data);

                 // hide the loading message
                 $('#loadingMessage').hide();

		}
        }
    };

  web_socket.onmessage = function (evt) {
        var data = evt.data;
        if (is("Blob", data)) {
            // for the example, treat binary as text
            var reader = new FileReader();
            reader.readAsText(data, "text/plain");
            reader.onload = function (reader_evt) {
                data = reader_evt.target.result;
                handle_message(data);
            };
        }
        else {
            handle_message(data);
        }
    };

    web_socket.onclose = function() {
        web_socket = undefined;
        
      	$('#connectionStatus').text("Not connected");
        console.log("Connection closed");        
    };
}

function close() {
    $('#connectionStatus').text("Not connected");

    if (web_socket == undefined) {    
        return;
    }
    web_socket.close();
}


function createCORSRequest(method, url) {
  console.log("Creating CORS Request " + method + " " + url);

  var xhr = new XMLHttpRequest();
  if ("withCredentials" in xhr) {

    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    xhr.open(method, url, true);

  } else if (typeof XDomainRequest != "undefined") {

    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xhr = new XDomainRequest();
    xhr.open(method, url);

  } else {

    // Otherwise, CORS is not supported by the browser.
    xhr = null;
    console.log("XHR not supported by this browser");

  }
  return xhr;
}


function setLevel() {

    var service_url = service_host + logging_level_set_service_name;
    var xhr = createCORSRequest('POST', service_url);
    if (!xhr) {
      throw new Error('CORS not supported');
    }

    xhr.onload = function() {
      var responseText = xhr.responseText;
      console.log(responseText);
      // process the response
    };

    xhr.onerror = function(xhr, textStatus, errorThrown) {
      console.log('There was an error.  Status ' + xhr.status);
      console.log('Error response=' + xhr.responseText);
    };

    var value_to_send = $("#set_level_input").val();
    console.log("Sending value " + value_to_send);
    xhr.send(value_to_send);
}


</script>


</head>
<body>
    <script type="text/javascript">
    
      // This function is called by the server when data is ready to be processed
      function updateTable(codePathEntries) {

          // clear table
          var oTable = $('#codePathTable').dataTable();
          oTable.fnClearTable();

          // process each object in the array            
          for (i = 0; i < codePathEntries.length; i++) {

		codePathEntry = codePathEntries[i];

              	oTable.fnAddData([
		        codePathEntry[0] 
		]);

          }

          // hide the loading message
          $('#loadingMessage').hide();
      }

    </script>
    <div id="logo">
      <img class="right" src="powered_by_cloudi.png"></img>
      <h1>Logging</h1>
    </div>
    
    <div id="loadingMessage">
      <h2>Waiting for data...</h2>
    </div>

	<div>
		<button class="left" onClick="send();">Refresh Now</button>
		<label hidden="true" id="codePath"></label>
		<label class="right" id="connectionStatus"></label>
	</div>

    <div>
	<label for"current_configuration">Current configuration:</label>
	<label id="current_configuration"></label>
    <div>
   
    <div>
	<button onclick="setFile();">Set File</button>
        <input id="set_file_input" type="text"></input>
    </div>

    <div>
	<button onclick="setLevel();">Set Level</button>
	<select id="set_level_input">
		<option value="error">Error</option>
		<option value="warn">Warn</option>
		<option value="info">Info</option>
		<option value="debug">Debug</option>
		<option value="trace">Trace</option>
	</select>
    </div>

    <div>
	<button onclick="setSyslog();">Set Syslog</button>
        <input id="set_syslog_input" type="text"></input>
    </div>

    <div>
	<button onclick="setFormatter();">Set Formatter</button>
        <input id="set_formatter_input" type="text"></input>
    </div>

 
    <div>
	<button onclick="setFile();">Set File</button>
        <input id="set_file_input" type="text"></input>
    </div>

    <script type="text/javascript">
	
	$(document).ready(function () {

		// show the loading message
		$('#loadingMessage').show();

		// set the connection status 
		$('#connectionStatus').text("Not connected");

		// call the service request function now
		send();
	});


    </script>
  </body>
</html>
