<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252"/>
    <title>Service Summary</title>

    <!-- link to JQuery and DataTables javascript libraries -->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
    <script src="http://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.js"></script>

    <!-- link to JQuery and DataTables CSS definitions -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="http://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.css" />

    <!-- define an internal style -->
    <style type="text/css">
        .right {
            float:right;
        }
    </style>

<script type="text/javascript">
var web_socket = undefined;
var host_url = "ws://127.0.0.1:6464";
var service_name = "/cloudi/api/rpc/services.erl";
var restart_service_name = "/cloudi/api/rpc/services_restart.erl";
var remove_service_name = "/cloudi/api/rpc/services_remove.erl";
var request_type = "get";


function is(type, obj) {
    if (obj === undefined)
        return type === 'undefined';
    else if (obj === null)
        return type === 'null';
    else
        return type === Object.prototype.toString.call(obj).slice(8, -1);
}

String.prototype.startsWith = function (str) {
    return this.slice(0, str.length) == str;
};


function send() {
	// if the web socket is undefined then try to open it 
	if (web_socket == undefined) {
		$('#connectionStatus').text("Not connected");
		open();
	}

	// if the web socket is in an open status then send the request
	if (web_socket.readyState == web_socket.OPEN) {
    		web_socket.send(request_type);
    		//console.log("Request (out): " + request_type);
	}
}

function open() {
    if (! ("WebSocket" in window)) {
      	$('#connectionStatus').text("Not connected");
        alert("This browser does not support WebSockets");
        return;
    }
    
    $('#connectionStatus').text("Connecting");
    web_socket = new WebSocket(host_url + service_name);

    console.log("Connecting to " + host_url + service_name);

    // define function that is called when the web socket is opened
    web_socket.onopen = function() {
        $('#connectionStatus').text("Connected");
        console.log("Connected");
	send();
    };

    handle_message = function (data) {
        if (data.startsWith("notification:")) {
            // client state check to determine this is an incoming
            // service request, not an incoming response
            console.log("Request (in): " + data);

            var response = "ok";
            web_socket.send(response);
            console.log("Response (in): " + response);

        }
        else {
            //console.log("Response (out): " + data);

		if (data != "got connect! yay!") {

			var service_entries = [];

			// attempt to parse the data response
	              	//console.log("parsing starts.  data is length " + data.length);
			
			var start = 0;
			var end = 0;

			do {
				// parse the service id
				start = data.indexOf("{\"", end);
				end = data.indexOf(",", start);
				var serviceID = data.substring(start+2, end-1);
				//console.log("serviceID= [" + serviceID+ "]");

				// parse the type
				//   {internal,
				start = data.indexOf("{", end);
				end = data.indexOf(",", start);
				var serviceType = data.substring(start+1, end);
			
				// parse the service path
				//   "/cloudi/api/",
				start = data.indexOf("\"", end);
				end = data.indexOf("\",", start);
				var servicePath = data.substring(start+1, end);

				// parse the module name
				//   "/cloudi/api/",
				start = end+2;
				end = data.indexOf(",", start);
				var serviceName = data.substring(start, end);
				//console.log("serviceName = [" + serviceName + "]");
			

				// skip to the next entry
				start = end+1;
				end = data.indexOf("}},", start);
				var miscStuff = data.substring(start, end);
				//console.log("miscStuff = " + miscStuff);
			
				var serviceEntry = new Object([serviceName, servicePath, serviceType, serviceID]);
				//console.log("serviceEntry=" + serviceEntry);
				
				// add the serviceEntry object to the array
				service_entries[service_entries.length] = serviceEntry;
				//console.log("service entries: " + service_entries);

			} while (end > 0);

			// display the service entries in the table
      			updateTable(service_entries);
	 
		}
        }
    };

  web_socket.onmessage = function (evt) {
        var data = evt.data;
        if (is("Blob", data)) {
            // for the example, treat binary as text
            var reader = new FileReader();
            reader.readAsText(data, "text/plain");
            reader.onload = function (reader_evt) {
                data = reader_evt.target.result;
                handle_message(data);
            };
        }
        else {
            handle_message(data);
        }
    };

    web_socket.onclose = function() {
        web_socket = undefined;
        
      	$('#connectionStatus').text("Not connected");
        console.log("Connection closed");        
    };
}

function close() {
    $('#connectionStatus').text("Not connected");

    if (web_socket == undefined) {    
        return;
    }
    web_socket.close();
}

function restart_service(serviceID) {
    var web_socket_restart = new WebSocket(host_url + restart_service_name);

    console.log("Connecting to " + host_url + restart_service_name);

    // define function that is called when the web socket is opened
    web_socket_restart.onopen = function() {
	var data = "[\"" + serviceID + "\"]";
	console.log("sending " + data);
    	web_socket_remove.send(data);
	web_socket_restart.close();
    };

    // clear the serviceID
    $('#serviceID').text("");	
} 

function remove_service(serviceID) {
    var web_socket_remove = new WebSocket(host_url + remove_service_name);

    console.log("Connecting to " + host_url + remove_service_name);

    // define function that is called when the web socket is opened
    web_socket_remove.onopen = function() {
	var data = "[\"" + serviceID + "\"]";
	console.log("sending " + data);
    	web_socket_remove.send(data);
	web_socket_remove.close();
    };

    // clear the serviceID
    $('#serviceID').text("");	
} 


</script>


</head>
<body>
    <script type="text/javascript">
    
      // This function is called by the server when data is ready to be processed
      function updateTable(serviceEntries) {

          // clear table
          var oTable = $('#servicesTable').dataTable();
          oTable.fnClearTable();

          // process each endpoint event in the array            
          for (i = 0; i < serviceEntries.length; i++) {

		serviceEntry = serviceEntries[i];

              	oTable.fnAddData([
		        serviceEntry[0], 
		        serviceEntry[1], 
		        serviceEntry[2],
		        serviceEntry[3]  
		]);

          }

          // hide the loading message
          $('#loadingMessage').hide();
      }


    </script>

    <div id="logo">
      <img class="right" src="powered_by_cloudi.png"></img>
      <h1>Service Summary</h1>
    </div>
    
    <div id="loadingMessage">
      <h2>Waiting for data...</h2>
    </div>

	<div>
		<button class="left" onClick="send();">Refresh Now</button>
    		<label hidden="true" id="serviceID"></label>
		<label class="right" id="connectionStatus"></label>
		<button id="remove_button">Remove Service</button>
		<button id="restart_button">Restart Service</button>
		<button id="show_subscriptions_button">Show Subscriptions</button>
	</div>


    <table id="servicesTable" class="display">
      <thead>
        <tr>
          <th>Name</th>
          <th>Path</th>
          <th>Type</th>
          <th>ID</th>
        </tr>
      </thead>
       
      <tbody id="servicesTableBody"></tbody>
    </table>
  

    <script type="text/javascript">
	$(document).ready(function () {

		// change the table attributes to support jQuery styles
		$('#servicesTable').dataTable( {
		  "bJQueryUI" : true, 
		  "sPaginationType" : "full_numbers"
		});

		// clear the table upon first displaying the page
		var oTable = $('#servicesTable').dataTable();
		oTable.fnClearTable();

		// show the loading message
		$('#loadingMessage').show();

		// set the connection status 
		$('#connectionStatus').text("Not connected");

		// call the service request function now
		send();

		// call the service request function every 60 seconds
		setInterval("send();",60000); 
	
		// hide the manage dialog
	//	$("#dialog").dialog({ autoOpen: false });


		// define a function that will highlight a row when selected
                $('#servicesTable tbody').on( 'click', 'tr', function () {

			// toggle the row highlighting color
		        if ( $(this).hasClass('selected') ) {
            			$(this).removeClass('selected');
        		}
		        else {
            			oTable.$('tr.selected').removeClass('selected');
            			$(this).addClass('selected');
        		}

			var table_api = $('#servicesTable').dataTable().api();
//			idx  = table_api.row(this).index();
//			console.log("index is " + idx);

//			console.log( table_api.row( this ).data() );

			// save the ServiceID in a hidden HTML object for use later
			var serviceEntry = table_api.row( this ).data();
//			console.log("serviceID is " + serviceEntry[3]);
		        $('#serviceID').text(serviceEntry[3]);
    		} );

	});

	
      // define a function to restart the selected service 
      $('#restart_button').click( function () {

	var serviceID = $('#serviceID').text();
	if (serviceID.length > 0) {
		console.log("Service ID is " + serviceID);
		restart_service(serviceID);
	}

      } );

      // define a function to remove the selected service 
      $('#remove_button').click( function () {

	var serviceID = $('#serviceID').text();
	if (serviceID.length > 0) {
		console.log("Service ID is " + serviceID);
		remove_service(serviceID);
	}

      } );



    </script>
  </body>
</html>
