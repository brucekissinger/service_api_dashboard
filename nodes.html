<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252"/>
    <title>Nodes</title>
    <!-- link to JQuery and DataTables javascript libraries -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/dataTables.jqueryui.js"></script>
    <!-- link to JQuery and DataTables CSS definitions -->
    <link rel="stylesheet" href="css/jquery-ui.css"/>
    <link rel="stylesheet" href="css/dataTables.jqueryui.css"/>
    <!-- define an internal style -->
    <style type="text/css">
        .right {
            float:right;
        }
        .loading {
            color:CornflowerBlue;
        }
    </style>
    <script type="text/javascript">
      var host_url = "ws://localhost:6464";
      var service_host = "http://localhost:6467";
      var service_name = "/cloudi/api/rpc/nodes.erl";
      var add_node_service_name = "/cloudi/api/rpc/nodes_add.erl";
      var remove_node_service_name = "/cloudi/api/rpc/nodes_remove.erl";
      var request_type = "get";
      var web_socket = undefined;

      function is(type, obj) {
          if (obj === undefined)
              return type === 'undefined';
          else if (obj === null)
              return type === 'null';
          else 
              return type === Object.prototype.toString.call(obj).slice(8,  - 1);
      }

      String.prototype.startsWith = function (str) {
          return this.slice(0, str.length) == str;
      };

      // This function uses a web socket to request the current node configuration
      function send() {
          // if the web socket is undefined then try to open it 
          if (web_socket == undefined) {
              $('#connectionStatus').text("Not connected");
              open();
          }

          // if the web socket is in an open status then send the request
          if (web_socket.readyState == web_socket.OPEN) {
              web_socket.send(request_type);
              //console.log("Request (out): " + request_type);
          }
      }

      // This function opens the web socket used to request the current node configuration
      function open() {
          if (!("WebSocket" in window)) {
              $('#connectionStatus').text("Not connected");
              alert("This browser does not support WebSockets");
              return;
          }

          $('#connectionStatus').text("Connecting");
          web_socket = new WebSocket(host_url + service_name);

          console.log("Connecting to " + host_url + service_name);

          // define function that is called when the web socket is opened
          web_socket.onopen = function () {
              $('#connectionStatus').text("Connected");
              console.log("Connected");
              send();
          };

          handle_message = function (data) {
              if (data.startsWith("notification:")) {
                  // client state check to determine this is an incoming
                  // service request, not an incoming response
                  console.log("Request (in): " + data);

                  var response = "ok";
                  web_socket.send(response);
                  console.log("Response (in): " + response);

              }
              else {
                  console.log("Response (out): " + data);

                  if (data != "got connect! yay!") {

                      var node_entries = [];

                      // attempt to parse the data response
                      console.log("parsing starts.  data is length " + data.length);

                      var start = 0;
                      var end = 0;

                      do {
                          // parse the discovery type
                          start = data.indexOf("{", end);

                          if (start > 0) {
                              end = data.indexOf(",", start);
                              if (end > 0) {
                                  var discoveryType = data.substring(start + 1, end);
                                  console.log("discoveryType= [" + discoveryType + "]");

                                  // parse the options 
                                  start = data.indexOf("[", end);
                                  end = data.indexOf("]", start);
                                  var options = data.substring(start + 1, end + 1);

                                  var nodeEntry = new Object([discoveryType, options]);

                                  // add the nodeEntry object to the array
                                  node_entries[node_entries.length] = nodeEntry;
                              }
                          }
                          //console.log("service entries: " + service_entries);
                      }
                      while (start > 0 && end > 0);

                      // display the node entries in the table
                      updateTable(node_entries);

                  }
              }
          };

          web_socket.onmessage = function (evt) {
              var data = evt.data;
              if (is("Blob", data)) {
                  // for the example, treat binary as text
                  var reader = new FileReader();
                  reader.readAsText(data, "text/plain");
                  reader.onload = function (reader_evt) {
                      data = reader_evt.target.result;
                      handle_message(data);
                  };
              }
              else {
                  handle_message(data);
              }
          };

          web_socket.onclose = function () {
              web_socket = undefined;

              $('#connectionStatus').text("Not connected");
              console.log("Connection closed");
          };
      }

      // This function closes the web socket used to request the current node configuration
      function close() {
          $('#connectionStatus').text("Not connected");

          if (web_socket == undefined) {
              return;
          }
          web_socket.close();
      }

      // Toggle button visiblity when an entry in the table is selected
      function toggle_manage_buttons() {
          // always show the add button
          $('#add_button').show();

          var nodeID = $('#nodeID').text();

          // show the remove button if the node is not an auto discovery node
          if (nodeID.length > 0 && nodeID != "discovery") {
              $('#remove_button').show();
          }
          else {
              $('#remove_button').hide();
          }
      }

      function createCORSRequest(method, url) {
          console.log("Creating CORS Request " + method + " " + url);

          var xhr = new XMLHttpRequest();
          if ("withCredentials" in xhr) {

              // Check if the XMLHttpRequest object has a "withCredentials" property.
              // "withCredentials" only exists on XMLHTTPRequest2 objects.
              xhr.open(method, url, true);

          }
          else if (typeof XDomainRequest != "undefined") {

              // Otherwise, check if XDomainRequest.
              // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
              xhr = new XDomainRequest();
              xhr.open(method, url);

          }
          else {

              // Otherwise, CORS is not supported by the browser.
              xhr = null;

          }
          return xhr;
      }

      // Submit an HTTP request to remove a node
      function remove_node(nodeID) {

          var remove_node_service_url = service_host + remove_node_service_name;
          var xhr = createCORSRequest('POST', remove_node_service_url);
          if (!xhr) {
              throw new Error('CORS not supported');
          }

          xhr.onload = function () {
              var responseText = xhr.responseText;
              console.log(responseText);

              // refresh the screen 
              send();
          };

          xhr.onerror = function () {
              console.log('There was an error!');

              // refresh the screen 
              send();
          };

          // clear the nodeID
          $('#nodeID').text("");

          // hide the manage node buttons
          toggle_manage_buttons();

          xhr.send('[\"' + nodeID + '\"]');
      }

      // Submit an HTTP request to add a node
      function add_node(nodeID) {

          var add_node_service_url = service_host + add_node_service_name;
          var xhr = createCORSRequest('POST', add_node_service_url);
          if (!xhr) {
              throw new Error('CORS not supported');
          }

          xhr.onload = function () {
              var responseText = xhr.responseText;
              console.log(responseText);

              // refresh the screen 
              send();
          };

          xhr.onerror = function () {
              console.log('There was an error!');

              // refresh the screen 
              send();
          };

          // clear the nodeID
          $('#nodeID').text("");

          // hide the manage node buttons
          toggle_manage_buttons();

          xhr.send('[\"' + nodeID + '\"]');
      }
    </script>
  </head>
  <body>
    <script type="text/javascript">
      // This function is called by the server when data is ready to be processed
      function updateTable(nodeEntries) {

          // clear table
          var oTable = $('#nodesTable').dataTable();
          oTable.fnClearTable();

          // process each endpoint event in the array            
          for (i = 0;i < nodeEntries.length;i++) {
              nodeEntry = nodeEntries[i];

              oTable.fnAddData([nodeEntry[0], nodeEntry[1]]);

          }

          // hide the loading message
          $('#loadingMessage').hide();
      }
    </script>
    <div id="logo">
      <img class="right" src="powered_by_cloudi.png"></img>
       
      <h1>Nodes</h1>
    </div>
    <div id="loadingMessage">
      <h2 class="loading">Waiting for data...</h2>
    </div>
    <div>
      <button class="left" onclick="send();">Refresh Now</button>
       
      <label hidden="true" id="nodeID"></label>
       
      <label class="right" id="connectionStatus"></label>
       
      <button id="remove_button">Remove Node</button>
       
      <button id="add_button">Add Node</button>
    </div>
    <table id="nodesTable" class="display">
      <thead>
        <tr>
          <th>Discovery Type</th>
          <th>Options</th>
        </tr>
      </thead>
       
      <tbody id="nodesTableBody"></tbody>
    </table>
    <script type="text/javascript">
      $(document).ready(function () {

          // change the table attributes to support jQuery styles
          $('#nodesTable').dataTable( {
              "bJQueryUI" : true, "sPaginationType" : "full_numbers"
          });

          // clear the table upon first displaying the page
          var oTable = $('#nodesTable').dataTable();
          oTable.fnClearTable();

          // show the loading message
          $('#loadingMessage').show();

          // set the connection status 
          $('#connectionStatus').text("Not connected");

          // call the service request function now
          send();

          // call the service request function every 60 seconds
          setInterval("send();", 60000);

          // hide the manage service buttons
          toggle_manage_buttons();

          // define a function that will highlight a row when selected
          $('#nodesTable tbody').on('click', 'tr', function () {

              // toggle the row highlighting color
              if ($(this).hasClass('selected')) {
                  $(this).removeClass('selected');
              }
              else {
                  oTable.$('tr.selected').removeClass('selected');
                  $(this).addClass('selected');
              }

              var table_api = $('#nodesTable').dataTable().api();

              // save the node ID in a hidden HTML object for use later
              var nodeEntry = table_api.row(this).data();
              console.log("nodeID is " + nodeEntry[0]);
              $('#nodeID').text(nodeEntry[0]);

              // hide the manage nodes buttons
              toggle_manage_buttons();
          });

      });

      // define a function to add a new node
      $('#add_button').click(function () {

          var nodeID = prompt("Enter new node", "");

          if (nodeID != null && nodeID.length > 0) {
              console.log("Node ID is " + nodeID);
              add_node(nodeID);
          }

      });

      // define a function to remove the selected node
          $('#remove_button').click(function () {

              var nodeID = $('#nodeID').text();
              if (nodeID.length > 0 && nodeID != "discovery") {
                  console.log("Node ID is " + nodeID);
                  remove_node(nodeID);
              }

          });
    </script>
  </body>
</html>
